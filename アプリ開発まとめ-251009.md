了解。次回以降に“同じハマり”を避けるための**再利用メモ**を録音アプリ依存を外して整理しました。必要なところはテンプレを**cat EOF 方式**でそのまま配れる形にしています。

---

# 共通ベストプラクティス（Windows/ Python GUI 全般）

## 1) BAT/シェル周りで躓いた点と対策

* **PowerShellにBATを貼らない。** BATは**cmd.exe**で実行（ダブルクリック or `cmd /c`）。
* **文字化け起因の誤動作**

  * `>` を画面表示で使うと**リダイレクト**になる → 表示では **`^>`** でエスケープ。
  * 文字コードは **ASCII or UTF-8 (BOMなし)**、**CRLF** 改行。
* **ウィンドウが即閉**: 末尾に `pause`、または**失敗時だけ止める**分岐を入れる。
* **`py` 依存は不安定**: いつも **`.venv\Scripts\python.exe` を最優先**、無ければ `python`、最後に `py -3`。

## 2) 依存管理・起動

* **プロジェクト毎に `.venv` を必須化**（汚染回避/ビルド一致）。
* 依存導入は**バイナリ優先**（`pip install --prefer-binary`）。
* 起動ランチャは**初回だけ venv 作成→依存導入→起動**、以後はそのまま起動。
* **設定ファイルの置き場**は `%APPDATA%\AppName\config.json` を既定（ポータブル化したい場合は exe と同階層に切替できる設計に）。

## 3) EXE 化で躓いた点と対策（PyInstaller）

* まずは **`--onefile --windowed` + `--collect-binaries <pkg>`** の**最小構成**で通す。

  * 問題が出たら spec に落としてから個別調整。
* **ビルド前プレフライト**：`import` のワンショット実行で**欠落即検知**。
* ビルドログは**ファイル出力 & 失敗時に最後の数百行を表示**、ウィンドウを閉じない。
* **外部ツール（ffmpeg 等）前提は避ける**。必要な場合は「自動検出→絶対パス実行→未検出時は機能無効/案内」の順でフォールバック。

## 4) エラー見える化・再現性

* **すべての自動処理はログ付き**（`>> build_log.txt 2>&1`）。
* **段階実行バッチ**を常備（どこで落ちたか即わかる）。
* プロジェクト雛形として**起動BAT/ビルドBAT**をコピー運用。

---

# そのまま使えるテンプレ

## A) 開発起動ランチャ（共通・最小）

```bash
BASE="E:/myApps/YourApp"
mkdir -p "$BASE"

cat > "$BASE/run_app.bat" << 'BAT'
@echo off
setlocal EnableExtensions
cd /d "%~dp0"

REM pick python (.venv -> python -> py -3)
set "PYCMD="
if exist ".venv\Scripts\python.exe" set "PYCMD=.venv\Scripts\python.exe"
if not defined PYCMD (where python >nul 2>nul && set "PYCMD=python")
if not defined PYCMD (where py >nul 2>nul && set "PYCMD=py -3")
if not defined PYCMD (echo [ERROR] Python not found & pause & exit /b 1)

if not exist ".venv" %PYCMD% -m venv .venv
call .venv\Scripts\activate.bat || (echo venv activate failed & pause & exit /b 1)

python -m pip install --upgrade --quiet pip
REM 依存を列挙：例) PySide6 or tkinter不要なら空でOK
python -m pip install --prefer-binary --quiet -r requirements.txt 2>nul

python main.py
echo ==== exit code: %ERRORLEVEL% ====
pause
BAT
```

> ポイント：`.venv` 最優先 / PowerShell無関係 / 失敗時に止まる。

---

## B) シンプル一発ビルド（spec不要・GUI向け）

```bash
BASE="E:/myApps/YourApp"
mkdir -p "$BASE/build"

cat > "$BASE/build/build_exe_simple.bat" << 'BAT'
@echo on
setlocal EnableExtensions
cd /d "%~dp0\.."

REM pick python (.venv -> python -> py -3)
set "PYCMD="
if exist ".venv\Scripts\python.exe" set "PYCMD=.venv\Scripts\python.exe"
if not defined PYCMD (where python >nul 2>nul && set "PYCMD=python")
if not defined PYCMD (where py >nul 2>nul && set "PYCMD=py -3")
if not defined PYCMD (echo [ERROR] Python not found & pause & exit /b 1)

if not exist ".venv" %PYCMD% -m venv .venv
call .venv\Scripts\activate.bat || (echo venv activate failed & pause & exit /b 1)

python -m pip install --upgrade --quiet pip
python -m pip install --prefer-binary --quiet pyinstaller

REM optional: 依存をここで入れる
REM python -m pip install --prefer-binary --quiet -r requirements.txt

REM import health check（任意：重要パッケージがあれば）
del /q "__tmp_check.py" 2>nul
> "__tmp_check.py" echo print("env ok")
python "__tmp_check.py" || (echo import check failed & pause & exit /b 1)
del /q "__tmp_check.py"

pyinstaller --clean --noconfirm --onefile --windowed ^
  --name your_app ^
  main.py || (echo pyinstaller failed & pause & exit /b 1)

if not exist ".\deliver" mkdir ".\deliver"
copy /Y ".\dist\your_app.exe" ".\deliver\your_app.exe"

> ".\deliver\start_silent.cmd" (
  echo @echo off
  echo cd /d "%%~dp0"
  echo start "" /wait "%%~dp0your_app.exe"
)

echo DONE: %CD%\deliver\your_app.exe
pause
BAT
```

> 依存 DLL を拾う必要があるライブラリ（例：Qt, PortAudio等）は
> `--collect-binaries <pkg>` を追加、複数あれば繰り返し指定。

---

## C) ログ付き・閉じない一括ビルド（拡張）

```bash
cat > "$BASE/build/build_exe.bat" << 'BAT'
@echo on
setlocal EnableExtensions EnableDelayedExpansion
cd /d "%~dp0\.."

set "LOG=%~dp0build_log.txt"
echo [BUILD START] %date% %time% > "%LOG%"

set "PYCMD="
if exist ".venv\Scripts\python.exe" set "PYCMD=.venv\Scripts\python.exe"
if not defined PYCMD ( where python >nul 2>nul && set "PYCMD=python" )
if not defined PYCMD ( where py >nul 2>nul && set "PYCMD=py -3" )
if not defined PYCMD ( echo [ERROR] Python not found >> "%LOG%" & goto ERR )
echo [INFO] Using: %PYCMD% >> "%LOG%"

if not exist ".venv" %PYCMD% -m venv .venv >> "%LOG%" 2>&1 || goto ERR
call .venv\Scripts\activate.bat || goto ERR

set "PYTHONUTF8=1"
set "PIP_DISABLE_PIP_VERSION_CHECK=1"
python -V >> "%LOG%" 2>&1
python -m pip install --upgrade --quiet pip >> "%LOG%" 2>&1
python -m pip install --prefer-binary --quiet pyinstaller >> "%LOG%" 2>&1
REM python -m pip install --prefer-binary --quiet -r requirements.txt >> "%LOG%" 2>&1

del /q "__tmp_check.py" 2>nul
> "__tmp_check.py" echo print("env ok")
python "__tmp_check.py" >> "%LOG%" 2>&1 || goto ERR
del /q "__tmp_check.py"

pyinstaller --clean --noconfirm --onefile --windowed ^
  --name your_app ^
  main.py >> "%LOG%" 2>&1 || goto ERR

if not exist ".\deliver" mkdir ".\deliver"
copy /Y ".\dist\your_app.exe" ".\deliver\your_app.exe" >> "%LOG%" 2>&1

echo [DONE] deliver\your_app.exe created >> "%LOG%"
echo.
echo *** BUILD SUCCESS ***
echo output: %CD%\deliver\your_app.exe
echo.
pause
exit /b 0

:ERR
echo.
echo *** BUILD FAILED ***
echo log: %LOG%
echo.
where powershell >nul 2>nul && (
  powershell -NoProfile -Command "Get-Content -LiteralPath '%LOG%' -Tail 200"
) || (
  type "%LOG%"
)
echo.
pause
exit /b 1
BAT
```

---

# 最後に：運用ルール（短縮版）

1. **BATはASCII/CRLF、日本語コメントは控えめ、`^>` を忘れない**
2. **`.venv` 最優先**、`--prefer-binary`、**プレフライトimport**
3. **ログを残す**（失敗時に閉じない）
4. **外部ツール依存は“自動検出→未検出時に graceful degrade”**
5. テンプレを**コピペ運用**して差分だけ編集（毎回ゼロから書かない）

このセットを“共通雛形”として新規プロジェクトの最初に置けば、今回のような初動トラブルはかなり抑えられます。必要なら「ポータブル設定保存版」「外部ツール自動検出ユーティリティ」もテンプレ化します。

---

## Git 共有手順メモ（WinLocalRecorder 用）

1. **プロジェクトへ移動**  
   PowerShell で `cd E:\myApps\old\STT_sound_record`

2. **初回だけリポジトリ作成**  
   `git init` → 成功メッセージが出れば OK

3. **無視リスト作成**  
   `notepad .gitignore` を実行して以下を貼り付け&保存  
   ```
   .venv/
   build/
   dist/
   deliver/
   *.spec
   *.zip
   *.log
   ```

4. **状態確認**  
   `git status` で赤いファイル（未管理）をチェック

5. **共有したいファイルをステージ**  
   ```
   git add file\abs\path\corder_app.py
   git add file\abs\path\run_recorder.bat
   git add file\abs\path\requirements.txt
   git add file\abs\path\launch_recorder.cmd
   git add "file\abs\path\アプリ開発まとめ-251009.md"
   ```

6. **もう一度状態確認**  
   `git status` → さっきのファイルが緑（Changes to be committed）ならOK

7. **コミット（説明付きスナップショット）**  
   `git commit -m "Add WinLocalRecorder sources and docs"`  
   *user.name/email 未設定なら*  
   `git config --global user.name "Your Name"`  
   `git config --global user.email "you@example.com"`

8. **リモート作成&接続**  
   GitHub で空リポジトリを作り、表示された URL を使って  
   `git remote add origin https://github.com/msknh123456-boop/MSK_NH_sound_recorde_01.git`

9. **アップロード（push）**  
   `git push -u origin main`  
   ※ブランチ名が master の場合は `main` → `master`

10. **ブラウザで確認**  
    GitHub 上でファイルが見えれば共有完了。追加説明や README を書き足すときは再度 `git add → git commit → git push` の流れで反映する。
